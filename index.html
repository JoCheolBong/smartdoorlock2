<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Capstone Map Test</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=0c43dda5249fa5372cb6f65f0320a50f&autoload=false"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    .hidden { display: none; }
    #map { width: 100%; height: 400px; }
    .loc-entry { margin: 5px 0; cursor: pointer; }
    .loc-entry:hover { font-weight: 600; text-decoration: underline; }
    .active { color: #ff5722; font-weight: 700; }
  </style>
</head>
<body>
  <div id="userList">
    <h2>사용자 목록</h2>
    <div class="user" data-name="김윤석">김윤석</div>
    <div class="user" data-name="김시현">김시현</div>
    <div class="user" data-name="김현준">김현준</div>
    <div class="user" data-name="이시현">이시현</div>
  </div>

  <div id="userInfo" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2 style="margin:0;">사용자 위치 기록</h2>
      <button onclick="closeUserInfo()">X</button>
    </div>
    <div id="infoArea">사용자를 선택해주세요.</div>
  </div>

  <div id="mapArea">
    <h2>지오펜스 화면</h2>
    <p id="mapUser">사용자를 선택하면 지오펜스가 표시됩니다.</p>
    <div id="map"></div>
  </div>

  <script>
    const userBaseLocations = {
      '김윤석': [37.5665, 126.9780],
      '김시현': [37.5651, 126.9895],
      '김현준': [37.5700, 126.9820],
      '이시현': [37.5720, 126.9765]
    };

    let map;
    let markerObjects = []; // [{marker, defaultImg}]
    let highlightImg, defaultImg;

    // ------------ 지도 초기화 ------------
    function initMap() {
      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 3
      });
      map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
      map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

      const imgSize = new kakao.maps.Size(24, 35);
      highlightImg = new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', imgSize);
      defaultImg   = new kakao.maps.MarkerImage('http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png', imgSize);

      document.querySelectorAll('.user').forEach(node => {
        node.addEventListener('click', () => selectUser(node.dataset.name));
      });
    }

    // ------------ 사용자 선택 → 마커 & 목록 렌더 ------------
    function selectUser(name){
      // 기존 마커 제거
      markerObjects.forEach(o => o.marker.setMap(null));
      markerObjects = [];

      const base = userBaseLocations[name];
      const deltas = [[0,0],[0.0005,0.0003],[0.001,0.0008]];
      const now  = new Date();
      const listHTML = [];

      deltas.forEach((d,idx)=>{
        const lat = base[0] + d[0];
        const lng = base[1] + d[1];
        const pos = new kakao.maps.LatLng(lat,lng);
        const timeStr = new Date(now - idx*5*60000).toTimeString().slice(0,5);

        const marker = new kakao.maps.Marker({ position: pos, map, image: defaultImg, draggable:true });
        markerObjects.push({ marker });

        if(idx===0) map.setCenter(pos);

        listHTML.push(`<div class="loc-entry" data-idx="${idx}">${timeStr} - (${lat.toFixed(5)}, ${lng.toFixed(5)})</div>`);
      });

      document.getElementById('infoArea').innerHTML = `<p><strong>이름:</strong> ${name}</p><h3>위치 기록</h3>${listHTML.join('')}`;
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('mapUser').textContent=`${name}의 지오펜스 화면입니다.`;

      document.querySelectorAll('.loc-entry').forEach(el=>{
        el.addEventListener('click',()=> highlightMarker(parseInt(el.dataset.idx,10), el));
      });
    }

    // ------------ 하이라이트 ------------
    function highlightMarker(idx, clickedEl){
      // 목록 강조 표시
      document.querySelectorAll('.loc-entry').forEach(el=>el.classList.remove('active'));
      if(clickedEl) clickedEl.classList.add('active');

      markerObjects.forEach((obj,i)=>{
        if(i===idx){
          obj.marker.setImage(highlightImg);
          obj.marker.setAnimation(kakao.maps.Animation.BOUNCE);
          map.panTo(obj.marker.getPosition());
        }else{
          obj.marker.setImage(defaultImg);
          obj.marker.setAnimation(null);
        }
      });
    }

    function closeUserInfo(){
      document.getElementById('userInfo').classList.add('hidden');
      document.getElementById('infoArea').innerHTML='사용자를 선택해주세요.';
    }

    document.addEventListener('DOMContentLoaded',()=>{
      kakao.maps.load(initMap);
    });
  </script>
</body>
</html>
