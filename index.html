<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Capstone Map Test</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=0c43dda5249fa5372cb6f65f0320a50f&autoload=false"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    #infoArea table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 12px;
    }
    #infoArea th, #infoArea td {
        border: 1px solid #ccc;
        padding: 4px 6px;
        text-align: center;
    }
    #infoArea th {
        background-color: #f0f0f0;
    }
    .loc-entry {
        cursor: pointer;
    }
    .loc-entry:hover {
        background-color: #f9f9f9;
    }
  </style>
</head>
<body>
  <div id="userList">
    <h2>사용자 목록</h2>
    <div class="user" data-name="김윤석">김윤석</div>
    <div class="user" data-name="김시현">김시현</div>
    <div class="user" data-name="김현준">김현준</div>
    <div class="user" data-name="이시현">이시현</div>
  </div>
  <div id="userInfo" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2 style="margin:0;">사용자 위치 기록</h2>
      <button onclick="closeUserInfo()">X</button>
    </div>
    <div id="infoArea"></div>
  </div>
  <div id="mapArea">
    <h2>지오펜스 화면</h2>
    <p id="mapUser">사용자를 선택하면 지오펜스가 표시됩니다.</p>
    <div id="map"></div>
  </div>
  <script>
    let map, markers = [];
    
    // 기존 kakao 지도 초기화 함수
    function initMap() {
      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 3
      });
    }
  
    kakao.maps.load(initMap);
  </script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
  
    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyDvKyi2EBgmyIY_pix7QLlj0G24qIlIv0k",
      authDomain: "capstone-smartdoorlock.firebaseapp.com",
      projectId: "capstone-smartdoorlock",
      storageBucket: "capstone-smartdoorlock.firebasestorage.app",
      messagingSenderId: "156309519192",
      appId: "1:156309519192:web:fd5d97931e5bbf089b432d"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
  
    // 내 위치 저장 함수
    async function saveMyLocation() {
      if (!navigator.geolocation) {
        alert("GPS 지원 안 하는 브라우저예요");
        return;
      }
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        console.log("내 위치:", lat, lng);
        // Firebase에 저장 (경로: locations/myUser)
        await set(ref(database, "locations/myUser"), {
          latitude: lat,
          longitude: lng,
          timestamp: Date.now()
        });
        alert("위치가 저장되었습니다!");
      }, (err) => {
        alert("위치 정보를 가져올 수 없습니다.");
        console.error(err);
      });
    }
  
    // 저장된 위치 실시간 감지 및 지도에 마커 표시
    function listenLocations() {
      const locationsRef = ref(database, "locations");
      onValue(locationsRef, (snapshot) => {
        const data = snapshot.val();
        // 기존 마커 제거
        markers.forEach(m => m.setMap(null));
        markers = [];
      
        if (data) {
          Object.entries(data).forEach(([userId, loc]) => {
            if (!loc.latitude || !loc.longitude) return;
            const pos = new kakao.maps.LatLng(loc.latitude, loc.longitude);
            const marker = new kakao.maps.Marker({
              position: pos,
              map: map
            });
            markers.push(marker);
          });
        }
      });
    }
  
    // 버튼 클릭 이벤트 연결
    document.getElementById("saveLocationBtn").addEventListener("click", saveMyLocation);
  
    // 지도 로딩 후 Firebase 리스너 시작
    kakao.maps.load(() => {
      initMap();
      listenLocations();
    });
  </script>
</body>
</html>
